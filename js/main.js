function assert(e,t){if(!e){if(t=t||"Assertion failed","undefined"!=typeof Error)throw new Error(t);throw t}}function selectionTileClick(e,t,s){t&&(Game.selectedTile=s)}function toggleLevelEditMode(){setLevelEditMode(!Game.levelEditMode)}function setLevelEditMode(e){Game.levelEditMode=e,Game.levelEditMode?(get("lvlEditInfo").style.backgroundColor="#134304",Game.sm.currentState().type===Game.types.states.GAME&&(get("lvledittilesarea").style.display="block")):(get("lvlEditInfo").style.backgroundColor="initial",get("lvledittilesarea").style.display="none")}function toggleDebug(){setDebug(!Game.debug)}function setDebug(e){Game.debug=e,Game.stats.domElement.style.display=Game.debug?"block":"none",Game.debug?(get("infoarea").style.display="block",get("debugInfo").style.backgroundColor="#134304"):(get("infoarea").style.display="none",get("debugInfo").style.backgroundColor="initial")}function clockwise(e){return e+=1,e>3&&(e=0),e}function anticlockwise(e){return e-=1,0>e&&(e=3),e}function add(e,t){return(e+t)%4}function sub(e,t){var s=e-t;return e=0>s?(4+s)%4:s}function opposite(e){return e===Game.NORTH?e=Game.SOUTH:e===Game.EAST?e=Game.WEST:e===Game.SOUTH?e=Game.NORTH:e===Game.WEST?e=Game.EAST:console.log("Invalid direction!! Direction: "+e),e}function keyPressed(e,t){if(Game.keysdown){var s=e.keyCode?e.keyCode:e.which;Game.keysdown[s]=t,Game.keysdown[Game.KEYBOARD.ONE]&&(Game.selectedTile=0),Game.keysdown[Game.KEYBOARD.TWO]&&(Game.selectedTile=1),Game.keysdown[Game.KEYBOARD.THREE]&&(Game.selectedTile=2),Game.keysdown[Game.KEYBOARD.FOUR]&&(Game.selectedTile=3)}}function boardClick(e,t,s,i){Game.sm.currentState().click(e,t,i,s)}function boardHover(e,t,s){Game.sm.currentState().hover(e,s,t)}function clickType(e){return 3===e.which||2===e.button?"right":1===e.which||0===e.button?"left":2===e.which||1===e.button?"middle":void 0}var get=function(e){return document.getElementById(e)},Game={};Game.init=function(){Game.version=.035,document.title="Mirrors V"+Game.version,get("versionNumber").innerHTML='<a href="https://github.com/ajweeks/mirrors-js" target="_blank" style="color: inherit; text-decoration: none;">V.'+Game.version+"</a>",Game.releaseStages={DEVELEOPMENT:"development",PRODUCTION:"production"},Bugsnag.appVersion=Game.version,Bugsnag.releaseStage=Game.releaseStages.PRODUCTION,Bugsnag.notifyReleaseStages=[Game.releaseStages.PRODUCTION],Game.types={},Game.types.tiles={},Game.types.colours={},Game.types.states={},Game.types.tiles.BLANK=0,Game.types.tiles.MIRROR=1,Game.types.tiles.POINTER=2,Game.types.tiles.RECEPTOR=3,Game.types.colours.RED=0,Game.types.colours.GREEN=1,Game.types.colours.BLUE=2,Game.types.colours.WHITE=3,Game.types.states.MAIN_MENU="mainmenustate",Game.types.states.GAME="gamestate",Game.types.states.ABOUT="aboutstate",Game.selectedTile=Game.types.tiles.BLANK,Game.images={},Game.images.lasers={},Game.images[Game.types.tiles.BLANK]=new Image,Game.images[Game.types.tiles.BLANK].src="res/blank.png",Game.images[Game.types.tiles.BLANK].alt="blank",Game.images[Game.types.tiles.MIRROR]=new Image,Game.images[Game.types.tiles.MIRROR].src="res/mirror.png",Game.images[Game.types.tiles.MIRROR].alt="mirror",Game.images[Game.types.tiles.POINTER]=new Image,Game.images[Game.types.tiles.POINTER].src="res/pointer.png",Game.images[Game.types.tiles.POINTER].alt="pointer",Game.images[Game.types.tiles.RECEPTOR]={},Game.images[Game.types.tiles.RECEPTOR][Game.types.colours.WHITE]=new Image,Game.images[Game.types.tiles.RECEPTOR][Game.types.colours.WHITE].src="res/receptor_white.png",Game.images[Game.types.tiles.RECEPTOR][Game.types.colours.WHITE].alt="receptor",Game.images[Game.types.tiles.RECEPTOR][Game.types.colours.RED]=new Image,Game.images[Game.types.tiles.RECEPTOR][Game.types.colours.RED].src="res/receptor_red.png",Game.images[Game.types.tiles.RECEPTOR][Game.types.colours.RED].alt="receptor",Game.images[Game.types.tiles.RECEPTOR][Game.types.colours.GREEN]=new Image,Game.images[Game.types.tiles.RECEPTOR][Game.types.colours.GREEN].src="res/receptor_green.png",Game.images[Game.types.tiles.RECEPTOR][Game.types.colours.GREEN].alt="receptor",Game.images[Game.types.tiles.RECEPTOR][Game.types.colours.BLUE]=new Image,Game.images[Game.types.tiles.RECEPTOR][Game.types.colours.BLUE].src="res/receptor_blue.png",Game.images[Game.types.tiles.RECEPTOR][Game.types.colours.BLUE].alt="receptor",Game.images.lasers[Game.types.colours.RED]=[],Game.images.lasers[Game.types.colours.RED]=new Image,Game.images.lasers[Game.types.colours.RED].src="res/laser_red.png",Game.images.lasers[Game.types.colours.RED].alt="red laser",Game.images.lasers[Game.types.colours.GREEN]=new Image,Game.images.lasers[Game.types.colours.GREEN].src="res/laser_green.png",Game.images.lasers[Game.types.colours.GREEN].alt="green laser",Game.images.lasers[Game.types.colours.BLUE]=new Image,Game.images.lasers[Game.types.colours.BLUE].src="res/laser_blue.png",Game.images.lasers[Game.types.colours.BLUE].alt="blue laser",Game.tileSize=64,Game.offset=[[0,-1],[1,0],[0,1],[-1,0]],Game.NORTH=0,Game.EAST=1,Game.SOUTH=2,Game.WEST=3,Game.NW=0,Game.NE=1,Game.ticks=0,Game.fps=65,Game.KEYBOARD={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,SPACE:32,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,TILDE:192},Game.keysdown=[],Game.stats=new Stats,Game.stats.setMode(0),Game.stats.domElement.style.position="absolute",Game.stats.domElement.style.left="0px",Game.stats.domElement.style.top="0px",document.body.appendChild(Game.stats.domElement),Game.prefs=[],Game.defaultPrefs=function(){setDebug("development"===Bugsnag.releaseStage),setLevelEditMode(!1),Game.prefs.warn=!Game.debug},Game.defaultPrefs(),Game.StateButton=function(e,t,s,i,a){this.text=e+"Button";var n='<div id="'+this.text+'" style="width: '+i+"px; height: "+a+"px; line-height: "+a+'px;"onclick="Game.sm.enterState(\''+t+"');"+(s||"")+'">'+e+"</div>";get("mainmenubuttons").innerHTML+=n,this.hide=function(){get(this.text).style.display="none"},this.restore=function(){get(this.text).style.display="block"},this.remove=function(){get("mainmenubuttons").removeChild(get(this.text))}},Game.MainMenuState=function(){this.type=Game.types.states.MAIN_MENU,this.play=new Game.StateButton("Play","game","",180,80),this.play=new Game.StateButton("About","about","",180,80),this.init=function(e){this.sm=e},this.update=function(){},this.render=function(){},this.click=function(){},this.hover=function(){},this.hide=function(){get("mainmenubuttons").style.display="none"},this.restore=function(){get("mainmenubuttons").style.display="block"},this.destroy=function(){}},Game.AboutState=function(){this.init=function(e){this.sm=e,this.type=Game.types.states.ABOUT,get("aboutstate").style.display="block"},this.update=function(){},this.render=function(){},this.restore=function(){get("aboutstate").style.display="block"},this.destroy=function(){get("aboutstate").style.display="none"}},Game.GameState=function(){this.init=function(e){this.sm=e,this.type=Game.types.states.GAME,this.board=new Game.GameState.Board(10,8,this),this.board.createBoard(),get("gamecanvas").style.display="block";var t='<div class="col"><div class="selectionTile" id="0tile" onmousedown="selectionTileClick(event, true, 0);" onmouseup="selectionTileClick(event, false, 0);" style="background-image: url(res/blank.png)"></div><div class="selectionTile" id="1tile" onmousedown="selectionTileClick(event, true, 1);" onmouseup="selectionTileClick(event, false, 1);" style="background-image: url(res/mirror.png)"></div><div class="selectionTile" id="2tile" onmousedown="selectionTileClick(event, true, 2);" onmouseup="selectionTileClick(event, false, 2);" style="background-image: url(res/pointer.png)"></div><div class="selectionTile" id="3tile" onmousedown="selectionTileClick(event, true, 3);" onmouseup="selectionTileClick(event, false, 3);" style="background-image: url(res/receptor_white.png)"></div></div>';get("lvledittiles").innerHTML=t,get("lvledittilescanvas").width=Game.tileSize,get("lvledittilescanvas").height=4*Game.tileSize,Game.levelEditMode&&(get("lvledittilesarea").style.display="block")},this.update=function(){this.board.update()},this.render=function(){this.board.render();var e;if(Game.levelEditMode){e=get("lvledittilescanvas").getContext("2d");for(var t=0;4>t;t++)e.fillStyle=Game.selectedTile===t?"#134304":"#121212",e.fillRect(0,t*Game.tileSize,Game.tileSize,Game.tileSize)}},this.restore=function(){get("gamecanvas").style.display="block",get("gamecanvas").style.display="block",Game.levelEditMode&&(get("lvledittilesarea").style.display="block")},this.destroy=function(){get("tiles").innerHTML="",get("gamecanvas").style.display="none",get("lvledittilesarea").style.display="none"},this.click=function(e,t,s,i){this.board.click(e,t,s,i)},this.hover=function(e,t,s){this.board.hover(e,t,s)}},Game.GameState.Laser=function(e,t,s){this.entering=e,this.exiting=t,this.image=s||Game.images.lasers[Game.types.colours.RED],this.render=function(e,t,s,i){null!==this.entering&&Game.renderImage(e,t,s,this.image,add(i,this.entering),Game.tileSize),null!==this.exiting&&Game.renderImage(e,t,s,this.image,add(i,this.exiting),Game.tileSize)}},Game.GameState.Receptor=function(e){this.col=e,this.laser=null,this.on=!1,this.update=function(){this.on=!1,this.on=null!==this.laser&&this.colourTurnsMeOn(this,this.laser.col)?!0:!1,this.on||(this.laser=null)},this.render=function(e,t,s,i){this.on&&(e.fillStyle="green",e.fillRect(t-Game.tileSize/2,s-Game.tileSize/2,Game.tileSize,Game.tileSize)),Game.renderImage(e,t,s,Game.images[Game.types.tiles.RECEPTOR][this.col],i,Game.tileSize)},this.colourTurnsMeOn=function(){return!0}},Game.GameState.Tile=function(e,t,s,i){this.x=e,this.y=t,this.type=s,this.hovering=!1,this.lasers=[],this.dir=i,this.maxdir=function(){switch(this.type){case Game.types.tiles.BLANK:return 0;case Game.types.tiles.MIRROR:return 1;case Game.types.tiles.POINTER:case Game.types.tiles.RECEPTOR:return 3;default:return 0}},this.init=function(){switch(this.on=!1,this.color=Game.types.colours.RED,this.type){case Game.types.tiles.BLANK:case Game.types.tiles.MIRROR:break;case Game.types.tiles.POINTER:this.addLaser(new Game.GameState.Laser(null,this.dir,Game.images.lasers[this.color]));break;case Game.types.tiles.RECEPTOR:this.receptors=[new Game.GameState.Receptor(Game.types.colours.BLUE),null,new Game.GameState.Receptor(Game.types.colours.GREEN),null]}},this.nextColor=function(e){switch(this.color){case Game.types.colours.RED:return Game.types.colours.GREEN;case Game.types.colours.GREEN:return Game.types.colours.BLUE;case Game.types.colours.BLUE:return e?Game.types.colours.WHITE:Game.types.colours.RED;case Game.types.colours.WHITE:return Game.types.colours.RED}return Game.types.colours.RED},this.click=function(e,t){switch(this.type){case Game.types.tiles.RECEPTOR:console.log("receptor! "+this.receptors[0].on);case Game.types.tiles.BLANK:case Game.types.tiles.MIRROR:if(t===!1)return;"left"===clickType(e)?(this.dir+=1,this.dir>this.maxdir()&&(this.dir=0)):"right"===clickType(e)&&Game.levelEditMode&&this.setType(Game.selectedTile);break;case Game.types.tiles.POINTER:if(t===!1)return;"left"===clickType(e)?(this.dir+=1,this.dir>this.maxdir()&&(this.dir=0)):"right"===clickType(e)&&(this.on=!this.on,this.on===!0?(Game.levelEditMode&&(this.color=this.nextColor(!1)),this.addLaser(new Game.GameState.Laser(null,this.dir,Game.images.lasers[this.color]))):this.removeAllLasers(),Game.levelEditMode&&this.setType(Game.selectedTile),console.log("pointer has "+this.lasers.length+" laser(s) and is "+(this.on?"on":"off")))}},this.setType=function(e){this.type=e,this.init()},this.hover=function(e){this.hovering=e},this.update=function(e){var t;switch(this.type){case Game.types.tiles.BLANK:case Game.types.tiles.MIRROR:break;case Game.types.tiles.RECEPTOR:for(t=0;t<this.lasers.length;t++)this.receptors[this.lasers[t].entering+this.dir]&&(this.receptors[this.lasers[t].entering+this.dir].laser=this.lasers[t]);for(t=0;t<this.receptors.length;t++)this.receptors[t]&&this.receptors[t].update();break;case Game.types.tiles.POINTER:if(this.on===!1)return;this.addLaser(new Game.GameState.Laser(null,this.dir,Game.images.lasers[this.color]));var s,i,a=[this.w*this.h],n=this.dir,l=e.getTile(this.x,this.y);for(t=0;t<this.w*this.h;t++)a[t]=0;do{if(s=l.x+Game.offset[n][0],i=l.y+Game.offset[n][1],0>s||s>=e.w||0>i||i>=e.h)break;if(a[s+i*e.w]>=2)break;if(a[s+i*e.w]++,l=e.getTile(s,i),!l)break;if(l.type===Game.types.tiles.POINTER)break;if(l.addLaser(new Game.GameState.Laser(opposite(n),null,Game.images.lasers[this.lasers[0].col])),!(l.lasers.length>0))break;n=l.lasers[l.lasers.length-1].exiting}while(null!==n)}},this.render=function(e,t,s){var i;switch(this.type){case Game.types.tiles.BLANK:case Game.types.tiles.MIRROR:case Game.types.tiles.POINTER:for(i=0;i<this.lasers.length;i++)this.lasers[i].render(e,t,s,0);Game.renderImage(e,t,s,Game.images[this.type],this.dir,Game.tileSize);break;case Game.types.tiles.RECEPTOR:for(i=0;i<this.lasers.length;i++)this.lasers[i].render(e,t,s,this.type===Game.types.tiles.POINTER?this.dir:0);for(i=0;i<this.receptors.length;i++)null!==this.receptors[i]&&this.receptors[i].render(e,t,s,this.dir+i)}},this.addLaser=function(e){switch(this.type){case Game.types.tiles.BLANK:e.exiting=opposite(e.entering);break;case Game.types.tiles.POINTER:if(this.lasers.length>0)return;e.exiting=null;break;case Game.types.tiles.RECEPTOR:e.exiting=null;break;case Game.types.tiles.MIRROR:this.dir===Game.NW?e.entering===Game.NORTH?e.exiting=Game.EAST:e.entering===Game.EAST?e.exiting=Game.NORTH:e.entering===Game.SOUTH?e.exiting=Game.WEST:e.entering===Game.WEST&&(e.exiting=Game.SOUTH):this.dir===Game.NE&&(e.entering===Game.NORTH?e.exiting=Game.WEST:e.entering===Game.WEST?e.exiting=Game.NORTH:e.entering===Game.EAST?e.exiting=Game.SOUTH:e.entering===Game.SOUTH&&(e.exiting=Game.EAST))}this.lasers.push(e)},this.removeAllLasers=function(){this.lasers=[]}},Game.GameState.Board=function(e,t,s){var i,a,n,l;for(this.w=e,this.h=t,this.gs=s,this.tiles=[e*t],a=0;e*t>a;a++)this.tiles[a]=new Game.GameState.Tile(a%e,Math.floor(a/e),Game.types.tiles.MIRROR,Game.NORTH),this.tiles[53]=new Game.GameState.Tile(53%e,Math.floor(53/e),Game.types.tiles.POINTER,Game.EAST),this.tiles[38]=new Game.GameState.Tile(38%e,Math.floor(38/e),Game.types.tiles.RECEPTOR,Game.NORTH),this.tiles[a].init();this.createBoard=function(){var s,r;for(i="",get("tiles").innerHTML=i,n=0;t>n;n++){for(i+='<div class="row">',l=0;e>l;l++)a=n*e+l,s=this.tiles[a].type,r=this.tiles[a].dir,this.tiles[a]=new Game.GameState.Tile(l,n,s,r),this.tiles[a].init(),i+='<div class="tile"onmousedown="boardClick(event, true, '+n+", "+l+');"onmouseup="boardClick(event, false, '+n+", "+l+');"onmouseover="boardHover(true, '+n+", "+l+');"onmouseout="boardHover(false, '+n+", "+l+');"style="top: '+n*Game.tileSize+"px; left: "+l*Game.tileSize+'px;"></div>';i+="</div>"}get("tiles").innerHTML=i,get("gameboard").style.left="50%",get("gameboard").style.marginLeft=-(e*Game.tileSize)/2+"px",get("gameboard").style.width=e*Game.tileSize+"px",get("gameboard").style.height=t*Game.tileSize+"px",get("gamecanvas").width=e*Game.tileSize,get("gamecanvas").height=t*Game.tileSize},this.update=function(){for(a=0;a<this.tiles.length;a++)this.tiles[a].removeAllLasers();for(a=0;a<this.tiles.length;a++)this.tiles[a].type===Game.types.tiles.POINTER&&this.tiles[a].update(this);for(a=0;a<this.tiles.length;a++)this.tiles[a].type!==Game.types.tiles.POINTER&&this.tiles[a].update()},this.getTile=function(e,t){return e>=0&&e<this.w&&t>=0&&t<this.h&&this.tiles[e+t*this.w]?this.tiles[e+t*this.w]:null},this.render=function(){var s=get("gamecanvas").getContext("2d");s.fillStyle="#0a0a0a",s.fillRect(0,0,this.w*Game.tileSize,this.h*Game.tileSize);var i=0;for(s.strokeStyle="#444444",i=0;e*t>i;i++)s.strokeRect(i%e*Game.tileSize,Math.floor(i/e)*Game.tileSize,Game.tileSize,Game.tileSize),this.tiles[i].render(s,i%e*Game.tileSize+Game.tileSize/2,Math.floor(i/e)*Game.tileSize+Game.tileSize/2)},this.click=function(e,t,s,i){this.tiles[i*this.w+s].click(e,t)},this.hover=function(e,t,s){this.tiles[s*this.w+t].hover(e)}},Game.InitStateList=function(){Game.StatesList={mainmenu:new Game.MainMenuState,about:new Game.AboutState,game:new Game.GameState}},Game.StateManager=function(){this.init=function(){Game.InitStateList(this),this.states=[],this.states.push(Game.StatesList.mainmenu),this.currentState().init(this)},this.update=function(){this.states.length>0&&this.currentState().update()},this.render=function(){this.states.length>0&&this.currentState().render()},this.enterState=function(e){this.currentState().hide(),this.states.push(Game.StatesList[e]),this.currentState().init(this)},this.enterPreviousState=function(){return this.states.length>1?(this.currentState().destroy(),this.states.pop(),this.currentState().restore(),!0):!1},this.currentState=function(){return this.states[this.states.length-1]},this.init()},Game.sm=new Game.StateManager,Game.renderImage=function(e,t,s,i,a,n){e.save(),e.translate(t,s),e.rotate(90*a*(Math.PI/180)),e.drawImage(i,-n/2,-n/2),e.restore()},Game.update=function(){Game.ticks+=1,Game.keysdown[Game.KEYBOARD.ESC]?this.sm.enterPreviousState():Game.keysdown[Game.KEYBOARD.ZERO]?toggleLevelEditMode():Game.keysdown[Game.KEYBOARD.NINE]&&toggleDebug(),Game.sm.update();for(var e=0;e<Game.keysdown.length;e++)Game.keysdown[e]=!1},Game.render=function(){Game.sm.render()},Game.loop=function(){Game.stats.begin(),Game.update(),(document.hasFocus()||Game.ticks%5===0)&&Game.render(),Game.stats.end(),window.setTimeout(Game.loop,1e3/Game.fps)}},window.onkeydown=function(e){keyPressed(e,!0)},window.onkeyup=function(e){keyPressed(e,!1)},window.onbeforeunload=function(e){Game.prefs.warn&&("undefined"==typeof e&&(e=window.event),e&&(e.returnValue="Are you sure you want to close Mirrors?"))},window.onload=function(){Game.init(),Game.loop()};